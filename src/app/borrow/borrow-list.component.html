<div class="card mb-3">
  <div class="card-body d-flex justify-content-between align-items-center">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb m-0 p-0">
        <li class="breadcrumb-item active"><a>Borrow List</a></li>
      </ol>
    </nav>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="d-flex mb-2 align-items-center">
      <select [(ngModel)]="filterStatus" (change)="load()" class="form-select w-auto">
        <option value="">All statuses</option>
        <option value="waiting_for_approval">Waiting for approval</option>
        <option value="approved">Approved</option>
        <option value="acquired">Acquired</option>
        <option value="in_return">In return</option>
        <option value="return_accepted">Return accepted</option>
        <option value="declined">Declined</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <button class="btn btn-outline-secondary btn-sm ms-2" (click)="load()" [disabled]="loading">Refresh</button>
    </div>

    <!-- Desktop Table View -->
    <div class="table-responsive d-none d-md-block">
      <table *ngIf="!loading && borrows.length" class="table table-sm table-hover">
        <thead>
          <tr>
            <th>#</th>
            <th>Room</th>
            <th>Item</th>
            <th>Qty</th>
            <th>Note</th>
            <th>Requester</th>
            <th>Status</th>
            <th>Requested</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let b of borrows">
            <td>{{ b.borrowId }}</td>
            <td>{{ b.room?.roomName }}</td>
            <td>
              {{ b.item?.name ?? b.itemName ?? b.itemType }}
            </td>
            <td>{{ b.quantity ?? '-' }}</td>
            <td>
              <!-- <div *ngIf="b.note"> -->
              <small class="text-muted">
                â€” {{ b.note }}
              </small>
              <!-- </div> -->
            </td>
            <td>{{ b.requester?.firstName}} {{b.requester?.lastName }}</td>
            <td>{{ b.status }}</td>
            <td>
              <small>
                {{ b.createdAt | date:'short' }}
              </small>
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary me-1" (click)="view(b)">View</button>

              <button *ngIf="showApproveDecline(b)" class="btn btn-sm btn-success me-1"
                (click)="approve(b)">Approve</button>
              <button *ngIf="showApproveDecline(b)" class="btn btn-sm btn-danger me-1"
                (click)="decline(b)">Decline</button>

              <button *ngIf="showAcquireCancel(b)" class="btn btn-sm btn-primary me-1"
                (click)="acquire(b)">Acquire</button>
              <button *ngIf="showAcquireCancel(b)" class="btn btn-sm btn-outline-danger me-1"
                (click)="cancel(b)">Cancel</button>

              <button *ngIf="showReturnButton(b)" class="btn btn-sm btn-warning me-1" (click)="markReturn(b)">Mark
                Return</button>

              <button *ngIf="showAcceptReturn(b)" class="btn btn-sm btn-dark me-1" (click)="acceptReturned(b)">Accept
                Return</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Mobile Card List View -->
    <div class="mobile-list-view d-md-none">
      <div *ngFor="let b of borrows" class="mobile-card mb-3">
        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
          <div class="fw-bold text-primary">#{{ b.borrowId }}</div>
          <div class="ms-auto">
            <span class="badge bg-secondary">{{ b.status }}</span>
          </div>
        </div>

        <div class="mobile-card-row">
          <span class="label">Room</span>
          <span class="value">{{ b.room?.roomName }}</span>
        </div>

        <div class="mobile-card-row">
          <span class="label">Requester</span>
          <span class="value">{{ b.requester?.firstName}} {{b.requester?.lastName }}</span>
        </div>

        <div class="mobile-card-row">
          <span class="label">Item</span>
          <span class="value">{{ b.item?.name ?? b.itemName ?? b.itemType }}</span>
        </div>

        <div class="mobile-card-row">
          <span class="label">Quantity</span>
          <span class="value">{{ b.quantity ?? '-' }}</span>
        </div>

        <div class="mobile-card-row" *ngIf="b.note">
          <span class="label">Note</span>
          <span class="value small text-muted">{{ b.note }}</span>
        </div>

        <div class="mobile-card-row">
          <span class="label">Date</span>
          <div class="value small text-muted">{{ b.createdAt | date:'short' }}</div>
        </div>

        <div class="mt-3 pt-2 border-top d-grid gap-2 d-flex justify-content-end flex-wrap">
          <button class="btn btn-sm btn-outline-primary flex-grow-1" (click)="view(b)">View</button>

          <button *ngIf="showApproveDecline(b)" class="btn btn-sm btn-success flex-grow-1"
            (click)="approve(b)">Approve</button>
          <button *ngIf="showApproveDecline(b)" class="btn btn-sm btn-danger flex-grow-1"
            (click)="decline(b)">Decline</button>

          <button *ngIf="showAcquireCancel(b)" class="btn btn-sm btn-primary flex-grow-1"
            (click)="acquire(b)">Acquire</button>
          <button *ngIf="showAcquireCancel(b)" class="btn btn-sm btn-outline-danger flex-grow-1"
            (click)="cancel(b)">Cancel</button>

          <button *ngIf="showReturnButton(b)" class="btn btn-sm btn-warning flex-grow-1" (click)="markReturn(b)">Mark
            Return</button>

          <button *ngIf="showAcceptReturn(b)" class="btn btn-sm btn-dark flex-grow-1" (click)="acceptReturned(b)">Accept
            Return</button>
        </div>
      </div>

      <div *ngIf="!loading && (!borrows || borrows.length === 0)" class="text-center py-5 text-muted">
        No borrow requests found.
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3" *ngIf="totalPages > 1 && !loading">
      <div class="text-muted">
        Showing {{ (page - 1) * limit + 1 }} to {{ (page * limit) > total ? total : (page * limit) }} of {{ total }}
        borrows
      </div>
      <nav aria-label="Page navigation">
        <ul class="pagination mb-0">
          <li class="page-item" [class.disabled]="page === 1">
            <button class="page-link" (click)="onPageChange(page - 1)">Previous</button>
          </li>
          <li class="page-item" *ngFor="let p of range(1, totalPages)" [class.active]="page === p">
            <button class="page-link" (click)="onPageChange(p)">{{ p }}</button>
          </li>
          <li class="page-item" [class.disabled]="page === totalPages">
            <button class="page-link" (click)="onPageChange(page + 1)">Next</button>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>