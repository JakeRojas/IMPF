<div class="scan-modal container-fluid p-0 d-flex flex-column h-100 bg-light">
  <!-- Header -->
  <div class="scan-header px-3 py-2 bg-dark text-white d-flex justify-content-between align-items-center shadow-sm">
    <div class="fw-bold d-flex align-items-center gap-2">
      <i class="bi bi-qr-code-scan"></i> Scan QR
    </div>
    <div>
      <button class="btn btn-sm btn-outline-light me-2" (click)="stopScanner()" [disabled]="!scanning">
        <i class="bi bi-pause-fill"></i> Stop
      </button>
      <button class="btn btn-sm btn-primary" (click)="startScanner()" [disabled]="scanning">
        <i class="bi bi-play-fill"></i> Start
      </button>
    </div>
  </div>

  <!-- Camera Viewport -->
  <div
    class="scan-body flex-grow-1 position-relative bg-black d-flex justify-content-center align-items-center overflow-hidden">
    <div class="scanner-wrapper position-relative" style="width: 100%; height: 100%; max-width: 600px;">
      <video #video autoplay muted playsinline class="w-100 h-100 object-fit-cover"></video>

      <!-- Overlay Guidelines -->
      <div
        class="scan-overlay position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center pe-none">
        <div class="scan-square position-relative"
          style="width: 250px; height: 250px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);">
          <!-- Corners -->
          <div class="corner top-left position-absolute top-0 start-0"
            style="border-top: 4px solid #0d6efd; border-left: 4px solid #0d6efd; width: 40px; height: 40px;"></div>
          <div class="corner top-right position-absolute top-0 end-0"
            style="border-top: 4px solid #0d6efd; border-right: 4px solid #0d6efd; width: 40px; height: 40px;"></div>
          <div class="corner bottom-left position-absolute bottom-0 start-0"
            style="border-bottom: 4px solid #0d6efd; border-left: 4px solid #0d6efd; width: 40px; height: 40px;"></div>
          <div class="corner bottom-right position-absolute bottom-0 end-0"
            style="border-bottom: 4px solid #0d6efd; border-right: 4px solid #0d6efd; width: 40px; height: 40px;"></div>

          <!-- Scanning Line Animation -->
          <div *ngIf="scanning" class="scan-line position-absolute w-100 bg-primary opacity-50"
            style="height: 2px; top: 0; animation: scanMove 2s infinite linear;"></div>
        </div>
      </div>

      <div *ngIf="!scanning && !lastResult"
        class="position-absolute top-50 start-50 translate-middle text-white text-center">
        <i class="bi bi-camera-video-off display-1 opacity-50"></i>
        <p class="mt-2">Scanner Paused</p>
      </div>
    </div>
  </div>

  <!-- Result / Action Panel -->
  <div class="scan-footer bg-white border-top shadow-lg" style="max-height: 50vh; overflow-y: auto;">
    <div class="p-3">
      <!-- Error Message -->
      <div *ngIf="errorMsg" class="alert alert-danger d-flex align-items-center mb-0">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>{{ errorMsg }}</div>
      </div>

      <!-- Result Card -->
      <div *ngIf="lastResult && !showBatchQtyInput" class="animate__animated animate__fadeInUp">
        <div *ngIf="lastScannedItem; else rawView">

          <!-- Header: Name & ID -->
          <div class="d-flex align-items-start gap-3 mb-3">
            <div class="bg-light rounded p-3 text-primary d-flex align-items-center justify-content-center"
              style="width: 60px; height: 60px;">
              <i class="bi bi-box-seam fs-2"></i>
            </div>
            <div class="flex-grow-1">
              <h5 class="mb-1 text-dark fw-bold text-break">
                {{ lastScannedItem.unit?.apparelName || lastScannedItem.inventory?.apparelName ||
                lastScannedItem.payload?.name || 'Unknown Item' }}
              </h5>
              <div class="text-muted small font-monospace">
                ID: {{ lastScannedItem.unit?.id || lastScannedItem.payload?.unitId || lastScannedItem.inventory?.id ||
                'N/A' }}
              </div>
            </div>
            <div>
              <span class="badge" [ngClass]="{
                'bg-success': (lastScannedItem.unit?.status === 'working' || lastScannedItem.unit?.status === 'in_stock'),
                'bg-warning text-dark': lastScannedItem.unit?.status === 'damage' || lastScannedItem.unit?.status === 'damaged',
                'bg-secondary': !lastScannedItem.unit?.status
              }">
                {{ (lastScannedItem.unit?.status || lastScannedItem.inventory?.status || 'Active') | titlecase }}
              </span>
            </div>
          </div>

          <div class="col-6">
            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Type</small>
            <div class="text-dark fw-semibold small">{{ extractItemType() | titlecase }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Kind</small>
            <div class="text-dark fw-semibold small">{{ lastScannedItem.kind || (isUnit() ? 'Unit' : 'Batch') |
              titlecase }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Ref/SKU</small>
            <div class="text-dark fw-semibold small text-truncate">{{ extractSku() }}</div>
          </div>
          <div class="col-6" *ngIf="!isUnit()">
            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Quantity</small>
            <div class="text-primary fw-bold">{{ getDisplayedQuantity() }}</div>
          </div>
        </div>

        <!-- Actions -->
        <div class="d-grid gap-2">
          <ng-container *ngIf="isUnit(); else batchBtns">
            <div class="btn-group shadow-sm" role="group">
              <button type="button" class="btn btn-outline-success" (click)="onWorkingClicked()">
                <i class="bi bi-check-circle me-1"></i> Working
              </button>
              <button type="button" class="btn btn-outline-warning" (click)="onDamageClicked()">
                <i class="bi bi-exclamation-circle me-1"></i> Damage
              </button>
            </div>
            <button class="btn btn-danger" (click)="onReleaseClicked()">
              <i class="bi bi-box-arrow-right me-1"></i> Release Unit
            </button>
          </ng-container>

          <ng-template #batchBtns>
            <div class="d-flex gap-2">
              <button class="btn btn-success flex-grow-1" (click)="onReceiveClicked()">
                <i class="bi bi-box-arrow-in-down me-1"></i> Receive
              </button>
              <button class="btn btn-danger flex-grow-1" (click)="onReleaseClicked()">
                <i class="bi bi-box-arrow-right me-1"></i> Release
              </button>
            </div>
          </ng-template>

          <button class="btn btn-secondary mt-1" (click)="scanAgain()">
            <i class="bi bi-qr-code me-1"></i> Scan Again
          </button>
        </div>
      </div>

      <!-- Raw View Fallback -->
      <ng-template #rawView>
        <div class="alert alert-warning mb-3">
          <i class="bi bi-info-circle me-1"></i> Unrecognized content format.
        </div>
        <div class="bg-light p-3 rounded mb-3 border font-monospace small" style="max-height: 100px; overflow: auto;">
          {{ lastResult }}
        </div>
        <button class="btn btn-secondary w-100" (click)="scanAgain()">Scan Again</button>
      </ng-template>
    </div>

    <!-- Batch Input Form -->
    <div *ngIf="showBatchQtyInput" class="animate__animated animate__fadeIn">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="fw-bold mb-3 d-flex align-items-center">
            <i class="bi me-2"
              [ngClass]="batchActionType === 'receive' ? 'bi-box-arrow-in-down text-success' : 'bi-box-arrow-right text-danger'"></i>
            {{ batchActionType === 'receive' ? 'Receive Batch' : 'Release Batch' }}
          </h5>

          <div class="alert alert-light border mb-3">
            <div class="d-flex justify-content-between">
              <div>
                <div class="small text-muted text-uppercase fw-bold">Item</div>
                <div class="fw-bold text-dark">{{ lastParsed?.name || lastParsed?.apparelName || 'Unknown Item' }}
                </div>
              </div>
              <div class="text-end">
                <div class="small text-muted text-uppercase fw-bold">Ref/SKU</div>
                <div class="fw-bold text-dark">{{ extractSku() }}</div>
              </div>
            </div>
            <div class="mt-2">
              <div class="small text-muted text-uppercase fw-bold">Type</div>
              <div class="text-dark">{{ extractItemType() | titlecase }}</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label small text-muted fw-bold">Quantity</label>
            <input type="number" class="form-control form-control-lg fw-bold text-center" [(ngModel)]="batchQty" min="1"
              placeholder="0" />
          </div>

          <div *ngIf="batchActionType === 'release'">
            <div class="mb-3">
              <label class="form-label small text-muted fw-bold">Claimed By</label>
              <input type="text" class="form-control" [(ngModel)]="claimedBy" placeholder="Name of claimer" />
            </div>
            <div class="mb-3">
              <label class="form-label small text-muted fw-bold">Released By</label>
              <input type="text" class="form-control" [(ngModel)]="releasedBy" readonly />
            </div>
          </div>

          <div class="mb-3" *ngIf="!lastParsed?.roomId">
            <label class="form-label small text-muted fw-bold">Room ID</label>
            <input type="number" class="form-control" [(ngModel)]="batchRoomIdInput" placeholder="Enter Room ID" />
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-lg" [ngClass]="batchActionType === 'receive' ? 'btn-success' : 'btn-danger'"
              (click)="confirmBatchAction()">
              Confirm {{ batchActionType | titlecase }}
            </button>
            <button class="btn btn-light border" (click)="cancelBatchAction()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>


</div>

<style>
  @keyframes scanMove {
    0% {
      top: 0;
      opacity: 0;
    }

    10% {
      opacity: 1;
    }

    90% {
      opacity: 1;
    }

    100% {
      top: 100%;
      opacity: 0;
    }
  }

  .object-fit-cover {
    object-fit: cover;
  }
</style>