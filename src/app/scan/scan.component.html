<div class="scan-modal container-fluid p-0">
  <div class="scan-header p-2 bg-dark text-white d-flex justify-content-between align-items-center">
    <div><strong>Scan QR</strong></div>
    <div>
      <button class="btn btn-sm btn-light me-2" (click)="stopScanner()" [disabled]="!scanning">Stop</button>
      <button class="btn btn-sm btn-primary" (click)="startScanner()" [disabled]="scanning">Start</button>
    </div>
  </div>

  <div class="scan-body d-flex justify-content-center align-items-center">
    <div class="scanner-wrapper">
      <video #video autoplay muted playsinline></video>

      <div #overlay class="scan-square">
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
      </div>
    </div>
  </div>

  <div class="scan-footer p-3">
  <div *ngIf="errorMsg" class="alert alert-danger">{{ errorMsg }}</div>

  <div *ngIf="lastResult && !showBatchQtyInput" class="card">
    <div class="card-body">
      <h5 class="card-title">Scanned item</h5>
  
      <div *ngIf="lastScannedItem; else rawView">
        <table class="table table-sm">
          <tr><th>Kind</th><td>{{ lastScannedItem.kind || (lastScannedItem.payload?.unitId ? 'unit' : 'batch') || '-' }}</td></tr>
          <tr><th>Item type</th><td>{{ lastScannedItem.payload?.itemType || lastScannedItem.type || '-' }}</td></tr>
          <tr><th>Unit ID</th><td>{{ lastScannedItem.unit?.id || lastScannedItem.payload?.unitId || '-' }}</td></tr>
          <tr><th>Inventory / Batch ID</th><td>{{ lastScannedItem.inventory?.id || lastScannedItem.payload?.id || lastScannedItem.payload?.inventoryId || '-' }}</td></tr>
          <tr><th>Name / Label</th><td>
            {{ lastScannedItem.unit?.apparelName || lastScannedItem.inventory?.apparelName || lastScannedItem.payload?.name || lastScannedItem.payload?.sku || '-' }}
          </td></tr>
          <tr><th>Qty (live)</th><td>{{ getDisplayedQuantity() }}</td></tr>
          <tr><th>Status</th><td>{{ lastScannedItem.unit?.status || lastScannedItem.inventory?.status || lastScannedItem.payload?.status || '-' }}</td></tr>
        </table>
      </div>
  
      <ng-template #rawView>
        <p><strong>Scanned text</strong></p>
        <pre style="max-height:120px;overflow:auto">{{ lastResult }}</pre>
        <div *ngIf="lastParsed">
          <p><strong>Parsed JSON</strong></p>
          <pre style="max-height:120px;overflow:auto">{{ lastParsed | json }}</pre>
        </div>
      </ng-template>
  
      <!-- <div class="mt-2">
        <button class="btn btn-danger me-2" (click)="onReleaseClicked()">Release</button>
        <button class="btn btn-outline-success me-2" (click)="onReceiveClicked()">Receive</button>
        <button class="btn btn-secondary me-2" (click)="scanAgain()">Scan again</button>
      </div> -->
      <div class="mt-2">
        <ng-container *ngIf="isUnit(); else batchBtns">
          <button class="btn btn-danger me-2" (click)="onReleaseClicked()">Release</button>
          <button class="btn btn-outline-warning me-2" (click)="onWorkingClicked()">Working</button>
          <button class="btn btn-outline-danger me-2" (click)="onDamageClicked()">Damage</button>
          <button class="btn btn-secondary me-2" (click)="scanAgain()">Scan again</button>
        </ng-container>
      
        <ng-template #batchBtns>
          <button class="btn btn-danger me-2" (click)="onReleaseClicked()">Release</button>
          <button class="btn btn-outline-success me-2" (click)="onReceiveClicked()">Receive</button>
          <button class="btn btn-secondary me-2" (click)="scanAgain()">Scan again</button>
        </ng-template>
      </div>
    </div>
  </div>
  <div *ngIf="showBatchQtyInput" class="card">
    <div class="card-body">
      <h5 class="card-title">{{ batchActionType === 'receive' ? 'Batch receive' : 'Batch ' + batchActionType }}</h5>
      <p *ngIf="lastParsed?.name"><strong>{{ lastParsed?.name }}</strong></p>
  
      <div class="mb-2">
        <label>Quantity to {{ batchActionType === 'receive' ? 'receive' : 'release' }}</label>
        <input type="number" class="form-control" [(ngModel)]="batchQty" min="1" />
      </div>
  
      <div class="mb-2" *ngIf="!lastParsed?.roomId">
        <label>Room ID (required)</label>
        <input type="number" class="form-control" [(ngModel)]="batchRoomIdInput" />
      </div>
  
      <div class="d-flex">
        <button type="button" class="btn"
                [ngClass]="batchActionType === 'receive' ? 'btn-success me-2' : 'btn-danger me-2'"
                (click)="confirmBatchAction()">
          {{ batchActionType === 'receive' ? 'Confirm receive' : 'Confirm release' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelBatchAction()">Cancel</button>
      </div>
    </div>
  </div>
</div>